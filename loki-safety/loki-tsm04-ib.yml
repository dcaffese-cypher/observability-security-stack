extensions:
  host_observer: {}

receivers:
  hostmetrics:
    root_path: /
    collection_interval: 15s
    scrapers:
      cpu: {}
      memory: {}
      disk: {}
      filesystem:
        exclude_mount_points:
          match_type: regexp
          mount_points:
            - ^/snap($|/).*
            - ^/boot($|/).*
            - ^/boot/efi($|/).*
        exclude_fs_types:
          match_type: strict
          fs_types: [squashfs, overlay, tmpfs, devtmpfs, proc, sysfs, devpts, cgroup2]
      network: {}
      load: {}
      paging: {}
      processes: {}

  # ⬇️ NEW: GPFS / Spectrum Scale
  filelog/gpfs:
    include: [ /var/adm/ras/mmfs.log.latest ]
    start_at: beginning
    include_file_path: true
    include_file_name: true   # ← optional but useful
    operators:
      - type: move
        from: attributes["log.file.path"]
        to: resource["log.file.path"]
      - type: add
        field: resource["log.type"]
        value: "gpfs"
      - type: add
        field: resource["component"]
        value: "mmfs"

  # System logs (always present)
  filelog/sys:
    include: [ /var/log/syslog, /var/log/messages, /var/log/*.log ]
    start_at: beginning
    include_file_path: true

  journald:
    units: ["*"]

  otlp:
    protocols:
      grpc: {}
      http: {}

processors:
  resourcedetection:
    detectors: [system]
    override: true

  resource/service:
    attributes:
      - action: upsert
        key: service.name
        # Replace YOUR_SERVER_HOSTNAME with your actual server hostname
        value: "YOUR_SERVER_HOSTNAME"

  resource/labels:
    attributes:
      - action: upsert
        key: cliente
        # Replace YOUR_CLIENT_NAME with your client identifier
        value: "YOUR_CLIENT_NAME"
      - action: upsert
        key: entorno
        # Replace YOUR_ENVIRONMENT with your environment (PRD, DEV, STG, etc.)
        value: "YOUR_ENVIRONMENT"
      - action: upsert
        key: pais
        # Replace YOUR_COUNTRY_CODE with your country code (AT, US, DE, etc.)
        value: "YOUR_COUNTRY_CODE"

  resource/loki_labels:
    attributes:
      - action: upsert
        key: host
        # Replace YOUR_SERVER_HOSTNAME with your actual server hostname
        value: "YOUR_SERVER_HOSTNAME"
      - action: upsert
        key: source
        value: "otelcol"

  batch: {}

exporters:
  otlphttp:
    # Replace MASTER_SERVER_IP with your master OpenTelemetry Collector server IP or hostname
    endpoint: "http://MASTER_SERVER_IP:4318"
    compression: gzip
    tls: { insecure: true }
    retry_on_failure: { enabled: true }

  otlp:
    # Replace MASTER_SERVER_IP with your master OpenTelemetry Collector server IP or hostname
    endpoint: "MASTER_SERVER_IP:4317"
    tls: { insecure: true }
    compression: gzip
    retry_on_failure: { enabled: true }

service:
  extensions: [host_observer]
  telemetry:
    logs: { level: info }
    metrics:
      readers:
        - pull:
            exporter:
              prometheus:
                host: "0.0.0.0"
                port: 8888

  pipelines:
    metrics:
      receivers: [hostmetrics]
      processors: [resourcedetection, resource/service, resource/labels, batch]
      exporters: [otlphttp]

    logs:
      receivers: [filelog/sys, filelog/gpfs, journald, otlp]
      processors: [resourcedetection, resource/service, resource/labels, resource/loki_labels, batch]
      exporters: [otlphttp]

    traces:
      receivers: [otlp]
      processors: [resourcedetection, resource/service, resource/labels, batch]
      exporters: [otlphttp]


# After configuration, restart the service:
# sudo systemctl restart otelcol
# sudo systemctl status otelcol
